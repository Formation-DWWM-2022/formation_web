# Cours de PHP, POO et MVC avancé

## Résumé du cours

Nous allons créer un projet en MVC contenant au moins trois tables : deux tables jointes par une relation N-N, avec une table de jointure entre les deux.
Le projet sera développé en architecture MVC et en utilisant des packages Composer.

Les projets sont les suivants :

# Liste des projets

## Projet 1 : gestion d'évènements pour Eventbrite
Vous allez créer un système de gestion d'évènements pour Eventbrite : l'utilisateur pourra créer des évènements et des utilisateurs, et les utilisateurs pourront s'inscrire à un ou plusieurs évènements. De même, on pourra ajouter un ou plusieurs utilisateurs à un évènement.
- Un évènement a plusieurs utilisateurs.
- Un utilisateur a plusieurs évènements.

## Projet 2 : tracker de films Netflix
Vous allez créer un tracker pour Netflix qui permettra de répertorier les films vus par un utilisateur, ainsi que la liste des utilisateurs ayant vu un film.
- Un utilisateur a vu plusieurs films.
- Un film a été vu par plusieurs utilisateurs.

## Projet 3 : gestion d'un panier de e-commerce pour Amazon
Vous allez créer un système de panier pour Amazon : on pourra ajouter plusieurs produits à un client, et on pourra ajouter plusieurs clients à un produit.
- Un client a plusieurs produits.
- Un produit a plusieurs clients.

## Projet 4 : création de playlists Spotify
Vous allez créer un système de playlists pour Spotify : un utilisateur pourra ajouter plusieurs musiques à sa playlist personnelle, et une musique pourra être ajouter dans les playlist de plusieurs utilisateurs.
- Une playlist a plusieurs musiques.
- Une musique appartient à plusieurs playlists.

## Projet 5 : bibliothèque de prêts Kindle
Vous allez créer le système de gestion de prêts de la bibliothèque Kindle. Un lecteur pourra louer plusieurs livres, et un livre pourra être loué à plusieurs utilisateurs.
- Un lecteur a plusieurs livres.
- Un livre est lu par plusieurs lecteurs.

# Projet d'exemple

> Tous vos projets vont pouvoir se calquer sur le projet suivant. Vous allez adapter les tables et models par rapport à l'exemple ci-dessous :

## Projet d'exemple : système de gestion de cours pour Harvard

Nous allons créer un système de gestion de classe et de cours.
- Chaque étudiant a plusieurs cours
- Chaque cours accueille plusieurs étudiants

Vous créérez les interfaces suivantes :

**AJOUTS**
- Ajout d'un nouvel étudiant
- Ajout d'un nouveau cours
- Attribution de plusieurs cours à un étudiant

**LISTES**
- Liste des étudiants
- Liste des cours
- Liste des inscriptions (liste de tous les cours et étudiants inscrits)

**PAGES**
- Page d'un étudiant et la liste de ses cours
- Page d'un cours et la liste des étudiants inscrits
- Dans chacune de ces pages, on pourra éditer les informations d'un étudiant ou les informations d'un cours
- Dans chacune de ces pages, on pourra supprimer les cours d'un étudiant, ou supprimer un étudiant d'un cours

## Travail avec Git

Vous travaillerez en groupe avec Git :
1. Un développeur créée le dépôt Git sur Github, en privé ou public.
2. Il invite en administrateur les autres développeurs.
3. Les autres développeurs vont cloner le dépôt Git sur leur ordinateur.
4. Tout le monde pourra effectuer des commits et les pusher sur le même repository.

## Résultat attendu

Vous trouverez une idée du résultat attendu ici : https://imgur.com/a/vinByNa. N'hésitez pas à adapter à votre projet ! Pensez à soigner le front une fois le back bien avancé.

# Développement de l'exercice

## 1. Création de la base de données

1. Vous créérez le modèle conceptuel de base de données sur papier, en listant les tables, les relations entre les tables, la liste des champs à insérer dans les tables.

2. Une fois le modèle validé, vous créérez la base de données.

## 2. Préparation des routes nécessaires

1. Vous listerez dans un document toutes les routes nécessaires à ce projet et leurs méthodes (`GET students`, `POST student`...).

## 3. Préparation du projet

1. Vous utiliserez le projet `base-mvc` que vous installerez (ouverture du projet avec VSCode puis `composer install` dans la console, et modification des fichiers de config de sorte à ce qu'ils correspondent à votre base de données, vos URL...).


## 4. Rédaction des routes

1. Traduisez les routes que vous aurez préparé au point 2. dans le fichier de routes de votre projet.
2. C'est l'occasion de prévoir les contrôleurs nécessaires et les méthodes associées !

## 5. Création des controllers

1. Créez les controllers nécessaires au projet et les méthodes associées.

## 6. Création des vues

1. Dans les controllers, appelez toutes les vues nécessaires aux affichages (`view('students.index')` par exemple), et créez les fichiers de vues.

## 7. Création des models

1. Créez un fichier Model par table. Pensez bien à hériter de la classe `Db` en déclarant le model ainsi : `class Student extends Db { }`
2. Pour chaque Model :
   1. Déclarez la constante `TABLE_NAME`
   2. Déclarez des attributs `protected` pour chacun des champs de la table correspondante
   3. Déclarez vos setters
   4. Déclarez vos getters

Rappel **setters** :
```php
    public function setName($name) {
        $this->name = $name;
        return $name;
    }
```

Rappel **getters** :
```php
    public function getName() {
        return $this->name;
    }
```

3. Ajoutez les méthodes suivantes à tous vos models **en les adaptant correctement pour chaque model** :

**Méthode save()** : (sauvegarder un nouvel objet en bdd)
```php
    public function save() {
        $data = [
            "firstname"  => $this->firstname(),
            "surname"   => $this->surname()
        ];
        if ($this->id > 0) return $this->update();
        $nouvelId = Db::dbCreate(self::TABLE_NAME, $data);
        $this->setId($nouvelId);
        return $this;
    }
```

**Méthode update()** : (mettre à jour l'objet en bdd)

```php
    public function update() {
        if ($this->id > 0) {
            $data = [
                "firstname"  => $this->firstname(),
                "surname"   => $this->surname()
            ];
            Db::dbUpdate(self::TABLE_NAME, $data);
            return $this;
        }
        return;
    }
```

**Méthode delete()** : (supprimer l'objet de la bdd)
```php
    public function delete() {
        $data = [
            'id' => $this->id(),
        ];

        Db::dbDelete(self::TABLE_NAME, $data);
        return;
    }
```

**Méthode findAll()** : (retrouver tous les éléments du Model)
```php
    public static function findAll() {
        $data = Db::dbFind(self::TABLE_NAME);
        return $data;
    }
```

**Méthode find()** : (retrouver en fonction d'un array `$request`)
```php
    public static function find(array $request) {
        $data = Db::dbFind(self::TABLE_NAME, $request);
        return $data;
    }
```

**Méthode findOne()** : (retrouver 1 élément en paramètre via son id)

```php
    public static function findOne(int $id) {
        $request = [
            ['id', '=', $id]
        ];
        $element = Db::dbFind(self::TABLE_NAME, $request);
        if (count($element) > 0) $element = $element[0];
        else return;

        return $element;

    }
```

## 8. Mettez à jour les contrôleurs

1. Vos Model maintenant créés, appelez les données depuis les contrôleurs, notamment dans les méthodes correspondant à l'affichage de listes.
   1. Par exemple : `$students = Student::findAll();`
2. Vous pouvez passer une variable `$students` à la vue de cette façon : `view('students.index', compact('students'));`

3. Mettez également à jour les méthodes correspondant à la création d'éléments en utilisant les méthodes des models, par exemple :
```php
// Route POST student
public function save() {
    $student = new Student;
    $student->setName($_POST['name']);
    $student->setBirthdate($_POST['birthdate']);
    $student->save();
}
```

4. Si vous êtes sûrs que vos formulaires fonctionnent parfaitement, vous pouvez rediriger vers une autre page à l'issue du traitement du formulaire :

```php
public function save() {
    $student = new Student;
    $student->setName($_POST['name']);
    $student->setBirthdate($_POST['birthdate']);
    $student->save();

    // On redirige vers la page d'un étudiant
    Header('Location: ' . url('/students/' . $student->getId() ));
}
```

## 9. Mettez à jour les vues

1. Maintenant que les controllers passent des données aux vues, mettez à jour vos fichiers de vues afin d'afficher les données. Par exemple avec un foreach pour les listes.

## 10. Pages Update

1. Créez une route `edit` qui prendra aussi en paramètres l'ID de l'élément à modifier
2. Créez la méthode dans le controlleur, qui va appeler la vue de la page d'update et qui va passer à la page l'élément à modifier
3. Dans la vue, dans les champs `value`, mettez la valeur actuelle de l'élément à modifier.
4. Faites pointer le formulaire vers une méthode de contrôleur dédiée à l'update

Routes :
```php
// Formulaire d'update
$router->get('student/{id}/edit', 'StudentsController@edit');

// Traitement de l'update
$router->post('student/{id}/edit', 'StudentsController@update');
```

Méthode affichant le formulaire:
```php
class StudentController {
    public function edit($id) {
        $student = Student::findOne($id);

        view('students.edit', compact('student'));
    }
}
```

Vue :

```php
<form action=">
    <input type="text" name="firstname" value="<?= $student->getName() ?>"
</form>
```

Méthode traitant le formulaire:
```php
class StudentController {
    public function update($id) {
        $student = Student::findOne($id);
        $student->setFirstname($_POST['firstname']);
        $student->update();

        // On redirige vers la page de l'étudiant
        Header('Location: ' . url('students/' . $student->getId() ));
    }
}
```


## 11. Suppression d'un enregistrement
Pour la suppression de l'enregistrement, il va falloir créer un lien ou un bouton qui redirige vers une méthode de contrôleur dédiée à cela :

Route vers laquelle pointe le bouton ou le lien de suppression :
```php
$routes->get('students/{id}/delete', 'StudentsController@delete');
```

Controller :

```php
class StudentsController {
    public function delete($id) {
        $student = Db::findOne($id);
        $student->delete();

        // On redirige vers la liste des étudiants
        Header('Location: ' . url('students'));
    }
}
```

## 12. Contrôles de saisie (validations)
Maintenant que les formulaires fonctionnent, tant pour créer que pour éditer, vous pouvez maintenant ajouter des validations dans les Model. Pour rappel, il faut ajouter les validations dans les `setters` : c'est en effet leur rôle ! Par exemple :

```php

public function setFirstname($name) {

    // Liste des validations
    if ( strlen($name) < 3) {
        throw new Exception ('Le nom est trop court.');
    }

    // Si pas d'erreur :
    $this->name = $name;
    return $this;
}
```

## 13. Améliorez les models pour afficher les relations

L'idée est de pouvoir faire des choses comme ceci dans les vues :

```php
Nom : <?= $student->firstname ?>
Liste des cours :

<?php foreach ($student->courses() as $course) : ?>

   Nom du cours : <?= $course->getTitle() ?>

<?php endforeach ?>
```

Ou bien l'inverse :

```php
Titre du cours : <?= $course->getTitle() ?>
Liste des étudiants :

<?php foreach ($course->students() as $student) : ?>

   Nom de l'élève : <?= $student->getFirstname() ?>

<?php endforeach ?>
```

C'est à dire que, depuis une vue concernant par exemple un étudiant, on aurait accès à ses cours ! C'est tout l'intérêt des relations, 1-1, 1-N ou N-N.

Voici comment procéder : on va utiliser une requête `INNER JOIN` écrite à la main dans le Model.

Fichier `Student.php`:
```php

class Student extends Db {

   // ...

   public function courses() {
   
      // J'utilise getDb de la classe Db qui me donne un pointeur PDO.
		$bdd = Db::getDb();

		// Définition de la requête
		$req = "SELECT *
				FROM `student_course`
				INNER JOIN course ON course.id =  student_course.id_course
            WHERE student_course.student_id = " . $this->getId();

		$res = $bdd->query($req);
		$courses = $res->fetchAll(PDO::FETCH_ASSOC);

		return $courses;
    }
}
```

> Pensez bien à tester dans PHPMyAdmin vos requêtes !

## 14. Développements complémentaires

### Alert en JS avant de supprimer
1. Ajoutez en Javascript une validation de suppression : lorsque l'on clique sur le lien ou le bouton de suppression, une `alert()` s'ouvre et nous demande de confirmer si on veut supprimer l'élément.

### Requêtes SQL
Vous rédigerez les requêtes SQL suivantes, qui peuvent être utiles dans les développements futurs de l'application :

- Afficher le nombre d'étudiants.
- Afficher le nombre de cours.
- Afficher le nombre d'inscriptions.
- Afficher les cours n’ayant pas d'étudiants
- Afficher les étudiants n’ayant pas de cours
- Afficher les cours suivis par l'étudiant « Jean Dupont » (adaptez à vos données)
- Afficher tous les étudiants (meme ceux qui n'ont pas de correspondance) ainsi que les cours
- Afficher les étudiants et tous les cours (meme ceux qui n'ont pas de correspondance)
- Afficher tous les étudiants et tous les cours, peut importe les correspondances. 

